<!DOCTYPE html>
<html>
<head>
	<title>啦啦啦字幕</title>
	<meta charset="utf-8">
	<script src="./script/vue.js"></script>
	<meta name='viewport' content="initial-scale=1 maximum-scale=1 width=device-width">

	<style type="text/css">
		.img{
			height: 100%;
			position: relative;
			bottom: -25px;
		}
	</style>

	<style type="text/css">
		*{
			padding: 0;
			margin: 0;
			position: relative;
			/*border: 1px red solid;*/
		}
		.img-box{
			position: absolute;
			height: 300px;
			bottom: 0;
			overflow: hidden;
		}
		.thumb-box{
			height: 50px;
		}
		.thumb-box-m{
			height: 100px;
		}
		.thumb-box-s{
			height: 50px;
		}
		.thumb-box-l{
			height: 150px;
		}
		.thumb-img{
			height: 100%;
		}
		.container{
			width: 100%;
			height: 400px;
			border: 1px red solid;

			/*display: none;*/
		}
		.test-box{

		}
		.details label{
			/*transform: scale(1);*/
			font-size: 24px;
		}
		.details input{
			width: 80px;
			/*height: 40px;*/
			font-size: 26px;
		}

		.details input[type="file"]{
			width: 300px;
			font-size: 20px;
			/*vertical-align: middle;*/
		}
	</style>
</head>
<body id='app'>
	<form class="details">
	<br>
		<label for='imgUpload'>批量上传：</label>
		<input type="file" id="imgUpload" multiple name='imgUpload' v-on:change='handlerUpload'>
	<!-- 	<label for='qty'>数量：</label>
	<input type="text" id="" name='qty' v-model='picQty'> -->
	<br>
	<label for='img_height'>首图高度：</label>
	<input type="num" id="" name='img_height' v-model='imgHeight'>
	<br>
	<label for='cut_height'>底部剪裁：</label>
	<input type="num" id="" name='cut_height' v-model='subCut'>
	<br>
	<label for='height'>字幕高度:</label>
	<input type="num" id="" name='height' v-model='subHeight' v-on:click=" decrease">
</form>

	<!-- <div class="container">
		<div class="img-box" v-for='img in imgs'>
			<img v-bind:src="'./img/'+img.index+'.png'" alt="" class="img">
		</div>
	</div> -->
	<div class="container">
		<div class="img-box" v-for='pic in pics'>
			<img v-bind:src="pic.src" alt="" class="img">
		</div>
	</div>
	<div class="thumb-container">
		<!-- <div class="thumb-box-m" v-for='pic in pics | orderBy "index" '> -->
		<div class="thumb-box-m" v-for='pic in pics | orderBy "index" '>
			<img v-bind:src="pic.src" alt="" class="thumb-img">
		</div>
	</div>
	<button id='generate'>生成图片</button>
	<canvas id="result" ></canvas>
	<!-- <input type="text" id="test" value="111"> -->
	<script type="text/javascript">
		var appVue=new Vue({
			el:'#app',
			data:{
				format:'png',
				imgs:[
				{index:3,format:'png'},
				{index:2,format:'png'},
				{index:1,format:'png'}
				],
				pics:['111'],
				imgHeight:300,
				subCut:25,
				subHeight:35,
				picQty:4,
				thumbHeight:50
			},
			methods:{
				setPst:function(){
					console.log('height',this.subHeight)
					// console.log('set pst')
					// console.log('data',this.$data)
					var imgBoxes=document.querySelectorAll('.img-box')
					,container=document.querySelector('.container')
					,imgs=document.querySelector('.img')
					,l=imgBoxes.length
					,subHeight=this.subHeight
					,subCut=this.subCut
					,imgHeight=this.imgHeight
					container.style.height=imgHeight*1+(l-1)*(subHeight)-subCut*1+'px'
					for(let i=0;i<l;i++){
						imgBoxes[i].style.bottom=subHeight*(i)+'px'
					}
					// console.log('imgBoxes',imgBoxes);
				},
				handlerUpload:function () {
					var self_=this
					var urls=getFileUrl('imgUpload'),l=urls.length-1
					this.pics=[]
					for(let i=l;i>=0;i--){
						this.pics.push({src:urls[i],index:i})
					}
					// console.log('pics',this.pics)
					// console.log('setpst',this.setPst)
					setTimeout(function() {
						self_.setPst()
					}, 10);
				},
				decrease:function(){
					// this.$data.subHeight++
				}
			}
		})

		appVue.$watch('picQty',function(newVal,oldVal){
			newVal=checkNum(newVal)
			this.picQty=newVal
			var currentQty=this.$data.imgs.length
			,self_=this
			console.log('currentQty',currentQty)
			if(currentQty<newVal){
				for(let i=currentQty+1;i<=newVal;i++){
					this.$data.imgs.unshift({index:i,format:'png'})
				}
			}else{
				while(this.$data.imgs.length!=newVal){
					this.$data.imgs.shift()
				}
			}
			setTimeout(function() {
				self_.setPst()
			}, 10);
		})
		appVue.$watch('subHeight',function(newVal,oldVal){	
			newVal=checkNum(newVal)
			this.subHeight=newVal
			this.setPst()
		})
		appVue.$watch('imgHeight',function(newVal,oldVal){	
			newVal=checkNum(newVal)
			this.imgHeight=newVal
			var imgs=document.querySelector('.container')
			.querySelectorAll('img'),
			self_=this
			imgs.forEach(function(item){
				item.style.height=self_.imgHeight+'px'
			})

		})
		appVue.$watch('subCut',function(newVal,oldVal){	
			newVal=checkNum(newVal)
			this.subCut=newVal
			var container=document.querySelector('.container')
			var imgs=container.querySelectorAll('img'),l=imgs.length
			self_=this
			container.style.height=self_.$data.imgHeight*1+(l-1)*
			(self_.$data.subHeight)-self_.$data.subCut*1+'px'
			console.log('imgs',imgs)
			// for(let i=0;i<imgs.length;i++){
			// 	imgs[i]
			// }
			this.setPst()
			imgs.forEach(function(item){
				item.style.bottom=-self_.$data.subCut+'px'
			})
		})
		console.log('appVue',appVue)
		appVue.setPst()
		function checkNum(val){
			// console.log('typeof val',typeof val)
			// if(typeof val!=='number'){
			// 	alert('请输入数字')
			// }
			return parseInt(val)
		}
		function getFileUrl(sourceId) {
			var urls = [];
			var files = document.getElementById(sourceId).files
			createURL(urls, files)
			// console.log('urls',urls);
			return urls;
		}
		function createURL(urls, files) {
			var l = files.length
			for (let i = 0; i < l; i++) {
				urls.push(window.URL.createObjectURL(files[i]))
			}
		}
		function generateImg(appVue){
			var imgs = document.querySelector('.container').querySelectorAll('img')
			console.log('imgs', imgs)
			var canvas = document.querySelector('#result'),
			ctx = canvas.getContext('2d')
			// appVue.$data.
			var ratio=0.3
			var l = imgs.length,
			subHeight = appVue.$data.subHeight,
			subCut = appVue.$data.subCut,
			imgHeight = appVue.$data.imgHeight
			canvas.height=ratio*imgs[0].naturalHeight
			canvas.width=ratio*imgs[0].naturalWidth
			// canvas.style.display='none'
			ctx.scale(ratio,ratio)
			ctx.drawImage(imgs[0],0,0)
			var imgData=ctx.getImageData(0,0,canvas.width,canvas.height)
			console.log('imgData',imgData)
			//计算画布高度  cvsHeight= firstHeight+ l-1 *subHeight
			//画布宽度 default = natrualWidth/naturalHeight*firstHeight
			//every single pst => center  
			//pstX: (cvsWidth-img[i].naturalWidth*ratio)/2
			//pstY: img[i].natueralHeight*raito+subHeight*(i-1)
			//ratio calculate seprately
			//翻转... rotate width <=> height
		}
		document.querySelector('#generate').onclick = function() {
			generateImg(appVue)
		}
	</script>
</body>
</html>